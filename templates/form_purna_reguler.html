<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulir Purna Reguler</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .tab-content { padding-top: 20px; }
        .slik-facility-hidden { display: none; }
        .mitigasi-hidden { display: none; }
        .alasan-wrapper { display: none; }
        .syarat-kustom-hidden { display: none; }
        
        /* (PERUBAHAN) Sembunyikan field domisili */
        .domisili-hidden { display: none; }

        #previewModal .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }
        #previewModal .row {
            border-bottom: 1px solid var(--bs-border-color-translucent);
            padding-bottom: 8px;
            margin-bottom: 8px;
        }
        #previewModal .row .col-md-4 {
            font-weight: bold;
        }
    </style>

    <script>
      (function() {
        const theme = localStorage.getItem('theme');
        if (theme) {
          document.documentElement.setAttribute('data-bs-theme', theme);
        }
      })();
    </script>
</head>
<body>

<div class="container my-5">
    <div class="row">
        <div class="col-md-10 mx-auto">
            <h2>Formulir Input: BNI Fleksi Pensiun Purna Reguler</h2>
            <p>Silakan isi data debitur dengan lengkap di bawah ini. Gunakan tab untuk berpindah kategori.</p>
            
            <form method="POST" action="/simpan" id="mainForm">
                <input type="hidden" name="debitur_id" value="{{ debitur_id | default('', true) }}">
                <input type="hidden" name="kategori" value="{{ kategori | default('purna_reguler', true) }}">

                <ul class="nav nav-tabs" id="formTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="pengajuan-slik-tab" data-bs-toggle="tab" data-bs-target="#pengajuan-slik" type="button" role="tab" aria-controls="pengajuan-slik" aria-selected="true">A. Pengajuan & SLIK</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="pemohon-tab" data-bs-toggle="tab" data-bs-target="#pemohon" type="button" role="tab" aria-controls="pemohon" aria-selected="false">B. Data Pemohon</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="pekerjaan-tab" data-bs-toggle="tab" data-bs-target="#pekerjaan" type="button" role="tab" aria-controls="pekerjaan" aria-selected="false">C. Data Pensiun</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="verifikasi-tab" data-bs-toggle="tab" data-bs-target="#verifikasi" type="button" role="tab" aria-controls="verifikasi" aria-selected="false">D. Verifikasi</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="usulan-tab" data-bs-toggle="tab" data-bs-target="#usulan" type="button" role="tab" aria-controls="usulan" aria-selected="false">E. Usulan Kredit</button>
                    </li>
                </ul>

                <div class="tab-content" id="formTabsContent">
                    
                    <div class="tab-pane fade show active" id="pengajuan-slik" role="tabpanel" aria-labelledby="pengajuan-slik-tab">
                        <h4 class="mb-3">A.1. Pengajuan Kredit</h4>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="plafon_kredit_dimohon" class="form-label">Plafon Dimohon (Rp)</label>
                                <input type="text" class="form-control" id="plafon_kredit_dimohon" name="plafon_kredit_dimohon" value="{{ data.get('plafon_kredit_dimohon', '') }}" required data-type="rupiah">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="jangka_waktu_dimohon_bulan" class="form-label">Jangka Waktu (Bulan)</label>
                                <input type="number" class="form-control" id="jangka_waktu_dimohon_bulan" name="jangka_waktu_dimohon_bulan" value="{{ data.get('jangka_waktu_dimohon_bulan', '') }}" required min="1">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="tujuan_kredit" class="form-label">Tujuan Kredit</label>
                            <input type="text" class="form-control" id="tujuan_kredit" name="tujuan_kredit" value="{{ data.get('tujuan_kredit', '') }}">
                        </div>
                        <hr class="my-4">
                        <h4 class="mb-3">A.2. Data SLIK</h4>
                        <div class="mb-3">
                            <label for="tgl_slik" class="form-label">Tanggal Cek SLIK</label>
                            <input type="date" class="form-control" id="tgl_slik" name="tgl_slik" value="{{ data.get('tgl_slik', '') }}">
                        </div>
                        <div class="mb-3 p-3 bg-light-subtle border rounded">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="toggle-fasilitas-nihil" name="fasilitas_nihil" value="ya" {% if data.get('fasilitas_nihil') == 'ya' %}checked{% endif %}>
                                <label class="form-check-label fw-bold" for="toggle-fasilitas-nihil">
                                    Calon Debitur TIDAK Memiliki Fasilitas Aktif (Nihil)
                                </label>
                            </div>
                        </div>
                        <div id="all-facilities-wrapper">
                            <p class="fw-bold">Data Fasilitas Aktif 1</p>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="slik_bank_1_jenis" class="form-label">Jenis</label>
                                    <input type="text" class="form-control" id="slik_bank_1_jenis" name="slik_bank_1_jenis" value="{{ data.get('slik_bank_1_jenis', '') }}">
                                </div>
                                <div class="col-md-8 mb-3">
                                    <label for="slik_bank_1_nama" class="form-label">Nama Bank</label>
                                    <input type="text" class="form-control" id="slik_bank_1_nama" name="slik_bank_1_nama" value="{{ data.get('slik_bank_1_nama', '') }}">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="slik_bank_1_maks" class="form-label">Plafon (Rp)</label>
                                    <input type="text" class="form-control" id="slik_bank_1_maks" name="slik_bank_1_maks" value="{{ data.get('slik_bank_1_maks', '') }}" data-type="rupiah">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="slik_bank_1_outs" class="form-label">Outstanding (Rp)</label>
                                    <input type="text" class="form-control" id="slik_bank_1_outs" name="slik_bank_1_outs" value="{{ data.get('slik_bank_1_outs', '') }}" data-type="rupiah">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="slik_bank_1_coll" class="form-label">Kolektibilitas</label>
                                    <input type="text" class="form-control" id="slik_bank_1_coll" name="slik_bank_1_coll" value="{{ data.get('slik_bank_1_coll', '') }}">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-8 mb-3">
                                    <label for="slik_bank_1_angsuran" class="form-label">Angsuran Eksisting (Rp)</label>
                                    <input type="text" class="form-control" id="slik_bank_1_angsuran" name="slik_bank_1_angsuran" value="{{ data.get('slik_bank_1_angsuran', '') }}" data-type="rupiah">
                                </div>
                            </div>
                            <div class="d-flex">
                                <div class="form-check mt-1">
                                    <input class="form-check-input toggle-alasan" type="checkbox" id="slik_bank_1_alasan_aktif" name="slik_bank_1_alasan_aktif" value="ya" data-target-alasan="#slik_bank_1_alasan" {% if data.get('slik_bank_1_alasan_aktif') == 'ya' %}checked{% endif %}>
                                    <label class="form-check-label" for="slik_bank_1_alasan_aktif">
                                        Tambahkan Alasan/Keterangan
                                    </label>
                                </div>
                            </div>
                            <div class="mb-3 alasan-wrapper">
                                <label for="slik_bank_1_alasan" class="form-label">Alasan/Keterangan Fasilitas 1</label>
                                <textarea class="form-control" id="slik_bank_1_alasan" name="slik_bank_1_alasan" rows="2" disabled>{{ data.get('slik_bank_1_alasan', '') }}</textarea>
                            </div>
                            
                            <div id="slik-facilities-container">
                                {% for i in range(2, 16) %}
                                    {% set nama_key = 'slik_bank_' ~ i ~ '_nama' %}
                                    {% set jenis_key = 'slik_bank_' ~ i ~ '_jenis' %}
                                    {% set maks_key = 'slik_bank_' ~ i ~ '_maks' %}
                                    {% set outs_key = 'slik_bank_' ~ i ~ '_outs' %}
                                    {% set coll_key = 'slik_bank_' ~ i ~ '_coll' %}
                                    {% set angsuran_key = 'slik_bank_' ~ i ~ '_angsuran' %}
                                    {% set alasan_aktif_key = 'slik_bank_' ~ i ~ '_alasan_aktif' %}
                                    {% set alasan_key = 'slik_bank_' ~ i ~ '_alasan' %}
                                    
                                    <div id="slik-facility-{{ i }}" class="slik-facility-hidden" 
                                         {% if data.get(nama_key) %}style="display: block;"{% endif %}>
                                        <hr>
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <p class="fw-bold mb-0">Data Fasilitas Aktif {{ i }}</p>
                                            <button type="button" class="btn btn-danger btn-sm slik-delete-btn" data-facility-id="{{ i }}">Hapus</button>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-4 mb-3">
                                                <label for="{{ jenis_key }}" class="form-label">Jenis</label>
                                                <input type="text" class="form-control" id="{{ jenis_key }}" name="{{ jenis_key }}" value="{{ data.get(jenis_key, '') }}">
                                            </div>
                                            <div class="col-md-8 mb-3">
                                                <label for="{{ nama_key }}" class="form-label">Nama Bank</label>
                                                <input type="text" class="form-control" id="{{ nama_key }}" name="{{ nama_key }}" value="{{ data.get(nama_key, '') }}">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-4 mb-3">
                                                <label for="{{ maks_key }}" class="form-label">Plafon (Rp)</label>
                                                <input type="text" class="form-control" id="{{ maks_key }}" name="{{ maks_key }}" value="{{ data.get(maks_key, '') }}" data-type="rupiah">
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label for="{{ outs_key }}" class="form-label">Outstanding (Rp)</label>
                                                <input type="text" class="form-control" id="{{ outs_key }}" name="{{ outs_key }}" value="{{ data.get(outs_key, '') }}" data-type="rupiah">
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label for="{{ coll_key }}" class="form-label">Kolektibilitas</label>
                                                <input type="text" class="form-control" id="{{ coll_key }}" name="{{ coll_key }}" value="{{ data.get(coll_key, '') }}">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-8 mb-3">
                                                <label for="{{ angsuran_key }}" class="form-label">Angsuran Eksisting (Rp)</label>
                                                <input type="text" class="form-control" id="{{ angsuran_key }}" name="{{ angsuran_key }}" value="{{ data.get(angsuran_key, '') }}" data-type="rupiah">
                                            </div>
                                        </div>
                                        <div class="d-flex">
                                            <div class="form-check mt-1">
                                                <input class="form-check-input toggle-alasan" type="checkbox" id="{{ alasan_aktif_key }}" name="{{ alasan_aktif_key }}" value="ya" data-target-alasan="#{{ alasan_key }}" {% if data.get(alasan_aktif_key) == 'ya' %}checked{% endif %}>
                                                <label class="form-check-label" for="{{ alasan_aktif_key }}">
                                                    Tambahkan Alasan/Keterangan
                                                </label>
                                            </div>
                                        </div>
                                        <div class="mb-3 alasan-wrapper">
                                            <label for="{{ alasan_key }}" class="form-label">Alasan/Keterangan Fasilitas {{ i }}</label>
                                            <textarea class="form-control" id="{{ alasan_key }}" name="{{ alasan_key }}" rows="2" disabled>{{ data.get(alasan_key, '') }}</textarea>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            <div class="mt-2 mb-3">
                                <button type="button" id="add-slik-facility" class="btn btn-sm btn-outline-primary">+ Tambah Fasilitas</button>
                            </div>
                        </div> <div class="form-check mt-4">
                            <input class="form-check-input" type="checkbox" id="toggle-mitigasi" name="mitigasi_aktif" value="ya" {% if data.get('mitigasi_aktif') == 'ya' %}checked{% endif %}>
                            <label class="form-check-label fw-bold" for="toggle-mitigasi">
                                Mitigasi SLIK (Aktifkan jika ada)
                            </label>
                        </div>
                        <div id="mitigasi-fields" class="mitigasi-hidden mt-3">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="mitigasi_slik_no_surat" class="form-label">No. Surat Mitigasi</label>
                                    <input type="text" class="form-control" id="mitigasi_slik_no_surat" name="mitigasi_slik_no_surat" value="{{ data.get('mitigasi_slik_no_surat', '') }}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="mitigasi_slik_tgl_surat" class="form-label">Tgl Surat Mitigasi</label>
                                    <input type="date" class="form-control" id="mitigasi_slik_tgl_surat" name="mitigasi_slik_tgl_surat" value="{{ data.get('mitigasi_slik_tgl_surat', '') }}">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="isi_perihal_surat" class="form-label">Isi Perihal Surat</label>
                                <input type="text" class="form-control" id="isi_perihal_surat" name="isi_perihal_surat" value="{{ data.get('isi_perihal_surat', '') }}">
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="pemohon" role="tabpanel" aria-labelledby="pemohon-tab">
                        <div class="mb-3">
                            <label for="nama_pemohon" class="form-label">Nama Pemohon</label>
                            <input type="text" class="form-control" id="nama_pemohon" name="nama_pemohon" value="{{ data.get('nama_pemohon', '') }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="no_telp_pemohon" class="form-label">No. Telepon/HP</label>
                            <input type="tel" class="form-control" id="no_telp_pemohon" name="no_telp_pemohon" value="{{ data.get('no_telp_pemohon', '') }}" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="alamat_ktp_pemohon" class="form-label">Alamat Sesuai KTP</label>
                            <textarea class="form-control" id="alamat_ktp_pemohon" name="alamat_ktp_pemohon" rows="2" required>{{ data.get('alamat_ktp_pemohon', '') }}</textarea>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="toggle-domisili" name="domisili_berbeda" value="ya" {% if data.get('domisili_berbeda') == 'ya' %}checked{% endif %}>
                            <label class="form-check-label" for="toggle-domisili">
                                Alamat Domisili berbeda dengan Alamat KTP
                            </label>
                        </div>
                        <div id="domisili-fields" class="domisili-hidden">
                            <div class="mb-3">
                                <label for="alamat_domisili_pemohon" class="form-label">Alamat Domisili</label>
                                <textarea class="form-control" id="alamat_domisili_pemohon" name="alamat_domisili_pemohon" rows="2">{{ data.get('alamat_domisili_pemohon', '') }}</textarea>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="status_rumah_pemohon" class="form-label">Status Rumah</label>
                                <input type="text" class="form-control" id="status_rumah_pemohon" name="status_rumah_pemohon" value="{{ data.get('status_rumah_pemohon', '') }}">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="lama_tinggal_tahun" class="form-label">Lama Tinggal (Tahun)</label>
                                <input type="number" class="form-control" id="lama_tinggal_tahun" name="lama_tinggal_tahun" value="{{ data.get('lama_tinggal_tahun', '') }}" min="0">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="lama_tinggal_bulan" class="form-label">Lama Tinggal (Bulan)</label>
                                <input type="number" class="form-control" id="lama_tinggal_bulan" name="lama_tinggal_bulan" value="{{ data.get('lama_tinggal_bulan', '') }}" min="0" max="11">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="tgl_lahir_pemohon" class="form-label">Tanggal Lahir</label>
                                <input type="date" class="form-control" id="tgl_lahir_pemohon" name="tgl_lahir_pemohon" value="{{ data.get('tgl_lahir_pemohon', '') }}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="usia_pemohon" class="form-label">Usia Pemohon</label>
                                <input type="number" class="form-control" id="usia_pemohon" name="usia_pemohon" value="{{ data.get('usia_pemohon', '') }}" readonly>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="no_ktp_pemohon" class="form-label">No. KTP (NIK)</label>
                                <input type="text" class="form-control" id="no_ktp_pemohon" name="no_ktp_pemohon" value="{{ data.get('no_ktp_pemohon', '') }}" required minlength="16" maxlength="16">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="tgl_terbit_ktp" class="form-label">Tgl Terbit KTP</label>
                                <input type="date" class="form-control" id="tgl_terbit_ktp" name="tgl_terbit_ktp" value="{{ data.get('tgl_terbit_ktp', '') }}">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="status_perkawinan_pemohon" class="form-label">Status Perkawinan</label>
                            <select class="form-select" id="status_perkawinan_pemohon" name="status_perkawinan_pemohon" required>
                                <option value="" {% if not data.get('status_perkawinan_pemohon') %}selected{% endif %}>-- Pilih Status --</option>
                                <option value="Belum Menikah" {% if data.get('status_perkawinan_pemohon') == 'Belum Menikah' %}selected{% endif %}>Belum Menikah</option>
                                <option value="Menikah" {% if data.get('status_perkawinan_pemohon') == 'Menikah' %}selected{% endif %}>Menikah</option>
                                <option value="Janda/Duda" {% if data.get('status_perkawinan_pemohon') == 'Janda/Duda' %}selected{% endif %}>Janda/Duda</option>
                            </select>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="pekerjaan" role="tabpanel" aria-labelledby="pekerjaan-tab">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="jenis_pekerjaan_pemohon" class="form-label">Jenis Pekerjaan (Pensiunan)</label>
                                <input type="text" class="form-control" id="jenis_pekerjaan_pemohon" name="jenis_pekerjaan_pemohon" value="{{ data.get('jenis_pekerjaan_pemohon', 'PNS') }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="nama_instansi_pemohon" class="form-label">Instansi Terakhir</label>
                                <input type="text" class="form-control" id="nama_instansi_pemohon" name="nama_instansi_pemohon" value="{{ data.get('nama_instansi_pemohon', '') }}" required>
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        <h4 class="mb-3">Data SK Pensiun</h4>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="no_sk_pensiun" class="form-label">No. SK Pensiun</label>
                                <input type="text" class="form-control" id="no_sk_pensiun" name="no_sk_pensiun" value="{{ data.get('no_sk_pensiun', '') }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="tgl_sk_pensiun" class="form-label">Tgl. SK Pensiun</label>
                                <input type="date" class="form-control" id="tgl_sk_pensiun" name="tgl_sk_pensiun" value="{{ data.get('tgl_sk_pensiun', '') }}">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="tgl_pensiun_tmt" class="form-label">TMT Pensiun</label>
                                <input type="date" class="form-control" id="tgl_pensiun_tmt" name="tgl_pensiun_tmt" value="{{ data.get('tgl_pensiun_tmt', '') }}" required>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="verifikasi" role="tabpanel" aria-labelledby="verifikasi-tab">
                        <h4 class="mb-3">D.1. Verifikasi Penghasilan Pensiun</h4>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="payroll_bank" class="form-label">Payroll di Bank</label>
                                <input type="text" class="form-control" id="payroll_bank" name="payroll_bank" value="{{ data.get('payroll_bank', '') }}">
                            </div>
                            <div class="col-md-8 mb-3">
                                <label for="payroll_no_rek" class="form-label">No. Rekening Payroll</label>
                                <input type="text" class="form-control" id="payroll_no_rek" name="payroll_no_rek" value="{{ data.get('payroll_no_rek', '') }}">
                            </div>
                        </div>
                        <p class="fw-bold mt-3">Verifikasi Gaji Pensiun Diterima</p>
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <label class="form-label">Bulan</label>
                                <input type="text" class="form-control mb-1" id="pensiun_bulan_nama" name="pensiun_bulan_nama" placeholder="Nama Bulan (cth: Sep 2025)" value="{{ data.get('pensiun_bulan_nama', '') }}">
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label">Jumlah Pensiun Diterima (Rp)</label>
                                <input type="text" class="form-control mb-1" id="pensiun_bulan_jumlah" name="pensiun_bulan_jumlah" placeholder="Jumlah Pensiun" value="{{ data.get('pensiun_bulan_jumlah', '') }}" required data-type="rupiah">
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        <h4 class="mb-3">D.2. Call Memo Kerabat</h4>
                        <div class="mb-3">
                            <label for="tgl_call_memo" class="form-label">Tanggal Telepon</label>
                            <input type="date" class="form-control" id="tgl_call_memo" name="tgl_call_memo" value="{{ data.get('tgl_call_memo', '') }}">
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="nama_kerabat" class="form-label">Nama Kerabat</label>
                                <input type="text" class="form-control" id="nama_kerabat" name="nama_kerabat" value="{{ data.get('nama_kerabat', '') }}">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="hubungan_kerabat" class="form-label">Hubungan</label>
                                <input type="text" class="form-control" id="hubungan_kerabat" name="hubungan_kerabat" value="{{ data.get('hubungan_kerabat', '') }}">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="no_telp_kerabat" class="form-label">No. Telp Kerabat</label>
                                <input type="tel" class="form-control" id="no_telp_kerabat" name="no_telp_kerabat" value="{{ data.get('no_telp_kerabat', '') }}">
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="usulan" role="tabpanel" aria-labelledby="usulan-tab">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="dsr_pemohon" class="form-label">DSR Pemohon (%)</label>
                                <input type="number" step="0.01" class="form-control" id="dsr_pemohon" name="dsr_pemohon" value="{{ data.get('dsr_pemohon', '') }}" min="0" readonly>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="program_kredit" class="form-label">Program Kredit</label>
                                <input type="text" class="form-control" id="program_kredit" name="program_kredit" value="{{ data.get('program_kredit', '') }}">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="usulan_plafon_kredit" class="form-label">Usulan Plafon (Rp)</label>
                                <input type="text" class="form-control" id="usulan_plafon_kredit" name="usulan_plafon_kredit" value="{{ data.get('usulan_plafon_kredit', '') }}" required readonly data-type="rupiah">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="usulan_jangka_waktu_bulan" class="form-label">Usulan J.Waktu (Bulan)</label>
                                <input type="number" class="form-control" id="usulan_jangka_waktu_bulan" name="usulan_jangka_waktu_bulan" value="{{ data.get('usulan_jangka_waktu_bulan', '') }}" required min="1" readonly>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="usulan_bunga_persen" class="form-label">Usulan Bunga (%)</label>
                                <input type="number" step="0.01" class="form-control" id="usulan_bunga_persen" name="usulan_bunga_persen" value="{{ data.get('usulan_bunga_persen', '') }}" required min="0">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label for="usulan_angsuran" class="form-label">Angsuran Kredit yang Diusulkan (Rp)</label>
                                <input type="text" class="form-control" id="usulan_angsuran" name="usulan_angsuran" value="{{ data.get('usulan_angsuran', '') }}" readonly data-type="rupiah">
                            </div>
                        </div>
                         <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="biaya_provisi_persen" class="form-label">Biaya Provisi (%)</label>
                                <input type="number" step="0.01" class="form-control" id="biaya_provisi_persen" name="biaya_provisi_persen" value="{{ data.get('biaya_provisi_persen', '') }}" min="0">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="biaya_provisi_nominal" class="form-label">Biaya Provisi (Rp)</label>
                                <input type="text" class="form-control" id="biaya_provisi_nominal" name="biaya_provisi_nominal" value="{{ data.get('biaya_provisi_nominal', '') }}" readonly data-type="rupiah">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="biaya_tata_laksana_persen" class="form-label">Biaya Tata Laksana (%)</label>
                                <input type="number" step="0.01" class="form-control" id="biaya_tata_laksana_persen" name="biaya_tata_laksana_persen" value="{{ data.get('biaya_tata_laksana_persen', '') }}" min="0">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="biaya_tata_laksana_nominal" class="form-label">Biaya Tata Laksana (Rp)</label>
                                <input type="text" class="form-control" id="biaya_tata_laksana_nominal" name="biaya_tata_laksana_nominal" value="{{ data.get('biaya_tata_laksana_nominal', '') }}" readonly data-type="rupiah">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="biaya_administrasi" class="form-label">Biaya Administrasi (Rp)</label>
                                <input type="text" class="form-control" id="biaya_administrasi" name="biaya_administrasi" value="{{ data.get('biaya_administrasi', '') }}" data-type="rupiah">
                            </div>
                            <div class="col-md-6 mb-3 d-flex align-items-end">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="bebas_biaya_administrasi" name="bebas_biaya_administrasi" value="ya" {% if data.get('bebas_biaya_administrasi') == 'ya' %}checked{% endif %}>
                                    <label class="form-check-label" for="bebas_biaya_administrasi">
                                        Bebas Biaya Administrasi
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="biaya_psjt_persen" class="form-label">Biaya PSJT (%)</label>
                            <input type="number" step="0.01" class="form-control" id="biaya_psjt_persen" name="biaya_psjt_persen" value="{{ data.get('biaya_psjt_persen', '') }}" min="0">
                        </div>
                        
                        <hr class="my-4">
                        <h4 class="mb-3">Blokir Angsuran</h4>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="blokir_angsuran_lunas" class="form-label">Jumlah Blokir Angsuran (kali)</label>
                                <input type="number" class="form-control" id="blokir_angsuran_lunas" name="blokir_angsuran_lunas" value="{{ data.get('blokir_angsuran_lunas', '') }}" min="0">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="blokir_angsuran_lunas_terbilang" class="form-label">Terbilang</label>
                                <input type="text" class="form-control" id="blokir_angsuran_lunas_terbilang" name="blokir_angsuran_lunas_terbilang" value="{{ data.get('blokir_angsuran_lunas_terbilang', '') }}" readonly>
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        <h4 class="mb-3">Syarat Tambahan Kustom</h4>
                        <p>Tambahkan syarat kustom yang akan muncul di dokumen. Pilih lokasinya (Penandatanganan atau Pencairan).</p>
                        
                        <div id="syarat-kustom-container">
                            {% for i in range(1, 11) %}
                                {% set teks_key = 'syarat_kustom_' ~ i ~ '_teks' %}
                                {% set lokasi_key = 'syarat_kustom_' ~ i ~ '_lokasi' %}
                                <div id="syarat-kustom-{{ i }}" class="syarat-kustom-hidden"
                                     {% if data.get(teks_key) %}style="display: block;"{% endif %}>
                                    <hr>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <p class="fw-bold mb-0">Syarat Tambahan {{ i }}</p>
                                        <button type="button" class="btn btn-danger btn-sm syarat-delete-btn" data-syarat-id="{{ i }}">Hapus</button>
                                    </div>
                                    <div class="mb-2">
                                        <label for="{{ teks_key }}" class="form-label">Teks Syarat</label>
                                        <textarea class="form-control" id="{{ teks_key }}" name="{{ teks_key }}" rows="2">{{ data.get(teks_key, '') }}</textarea>
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label d-block">Lokasi di Dokumen</label>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" id="{{ lokasi_key }}_penandatanganan" name="{{ lokasi_key }}" value="penandatanganan" {% if data.get(lokasi_key) == 'penandatanganan' or not data.get(lokasi_key) %}checked{% endif %}>
                                            <label class="form-check-label" for="{{ lokasi_key }}_penandatanganan">Syarat Penandatanganan</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" id="{{ lokasi_key }}_pencairan" name="{{ lokasi_key }}" value="pencairan" {% if data.get(lokasi_key) == 'pencairan' %}checked{% endif %}>
                                            <label class="form-check-label" for="{{ lokasi_key }}_pencairan">Syarat Pencairan</label>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        <div class="mt-2 mb-3">
                            <button type="button" id="add-syarat-kustom" class="btn btn-sm btn-outline-success">+ Tambah Syarat Kustom</button>
                        </div>
                    </div>
                </div>

                <div class="mt-4 d-flex justify-content-between align-items-center">
                    <div>
                        <button type="submit" class="btn btn-primary btn-lg">
                            Simpan Data Debitur
                        </button>
                        <a href="/" class="btn btn-secondary btn-lg">Kembali ke Menu</a>
                    </div>
                    <div>
                        <button type="button" class="btn btn-outline-secondary btn-lg" id="theme-toggler">
                            ðŸŒ— Ganti Tema
                        </button>
                    </div>
                </div>

            </form>
        </div>
    </div>
</div>


<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl"> 
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalLabel">Preview Data Debitur</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Mohon periksa kembali data di bawah ini. Jika sudah benar, klik "Ya, Simpan Data".</p>
                <hr>

                <h4 class="mb-3 mt-4">A.1. Pengajuan Kredit</h4>
                <div class="row"><div class="col-md-4">Plafon Dimohon (Rp):</div><div class="col-md-8"><span id="preview_plafon_kredit_dimohon"></span></div></div>
                <div class="row"><div class="col-md-4">Jangka Waktu (Bulan):</div><div class="col-md-8"><span id="preview_jangka_waktu_dimohon_bulan"></span></div></div>
                <div class="row"><div class="col-md-4">Tujuan Kredit:</div><div class="col-md-8"><span id="preview_tujuan_kredit"></span></div></div>
                
                <h4 class="mb-3 mt-4">A.2. Data SLIK</h4>
                <div class="row"><div class="col-md-4">Tanggal Cek SLIK:</div><div class="col-md-8"><span id="preview_tgl_slik"></span></div></div>
                
                <div id="preview-facilities-wrapper">
                    <p class="fw-bold mb-1 mt-3">Fasilitas Aktif 1:</p>
                    <div class="row">
                        <div class="col-md-12">
                            Jenis: <span id="preview_slik_bank_1_jenis"></span>,
                            Bank: <span id="preview_slik_bank_1_nama"></span>,
                            Plafon: <span id="preview_slik_bank_1_maks"></span>,
                            O/S: <span id="preview_slik_bank_1_outs"></span>,
                            Kol: <span id="preview_slik_bank_1_coll"></span><br>
                            <strong>Angsuran: <span id="preview_slik_bank_1_angsuran"></span></strong>
                            <div class="alasan-wrapper" id="preview-alasan-wrapper-1">
                                <strong>Alasan:</strong> <span id="preview_slik_bank_1_alasan"></span>
                            </div>
                        </div>
                    </div>

                    {% for i in range(2, 16) %}
                    <div id="preview-slik-facility-{{ i }}" class="slik-facility-hidden">
                        <p class="fw-bold mb-1 mt-3">Fasilitas Aktif {{ i }}:</p>
                        <div class="row">
                            <div class="col-md-12">
                                Jenis: <span id="preview_slik_bank_{{ i }}_jenis"></span>,
                                Bank: <span id="preview_slik_bank_{{ i }}_nama"></span>,
                                Plafon: <span id="preview_slik_bank_{{ i }}_maks"></span>,
                                O/S: <span id="preview_slik_bank_{{ i }}_outs"></span>,
                                Kol: <span id="preview_slik_bank_{{ i }}_coll"></span><br>
                                <strong>Angsuran: <span id="preview_slik_bank_{{ i }}_angsuran"></span></strong>
                                <div class="alasan-wrapper" id="preview-alasan-wrapper-{{ i }}">
                                    <strong>Alasan:</strong> <span id="preview_slik_bank_{{ i }}_alasan"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <div id="preview-fasilitas-nihil" class="slik-facility-hidden">
                    <p class="fw-bold mb-1 mt-3">Fasilitas Aktif:</p>
                    <div class="row"><div class="col-md-12">1. Nihil - Data Fasilitas Kredit tidak ditemukan.</div></div>
                </div>

                <div id="preview-mitigasi-section" class="mitigasi-hidden">
                    <p class="fw-bold mb-1 mt-3">Mitigasi SLIK:</p>
                    <div class="row"><div class="col-md-4">No. Surat Mitigasi:</div><div class="col-md-8"><span id="preview_mitigasi_slik_no_surat"></span></div></div>
                    <div class="row"><div class="col-md-4">Tgl Surat Mitigasi:</div><div class="col-md-8"><span id="preview_mitigasi_slik_tgl_surat"></span></div></div>
                    <div class="row"><div class="col-md-4">Isi Perihal Surat:</div><div class="col-md-8"><span id="preview_isi_perihal_surat"></span></div></div>
                </div>
                
                <h4 class="mb-3 mt-4">B. Data Pemohon</h4>
                <div class="row"><div class="col-md-4">Nama Pemohon:</div><div class="col-md-8"><span id="preview_nama_pemohon"></span></div></div>
                <div class="row"><div class="col-md-4">No. Telepon/HP:</div><div class="col-md-8"><span id="preview_no_telp_pemohon"></span></div></div>
                <div class="row"><div class="col-md-4">Alamat Sesuai KTP:</div><div class="col-md-8"><span id="preview_alamat_ktp_pemohon" style="white-space: pre-wrap;"></span></div></div>

                <div class="row domisili-hidden" id="preview-domisili-wrapper">
                    <div class="col-md-4">Alamat Domisili:</div>
                    <div class="col-md-8"><span id="preview_alamat_domisili_pemohon" style="white-space: pre-wrap;"></span></div>
                </div>

                <div class="row"><div class="col-md-4">Status Rumah:</div><div class="col-md-8"><span id="preview_status_rumah_pemohon"></span></div></div>
                <div class="row"><div class="col-md-4">Lama Tinggal:</div><div class="col-md-8"><span id="preview_lama_tinggal_tahun"></span> Tahun, <span id="preview_lama_tinggal_bulan"></span> Bulan</div></div>
                <div class="row"><div class="col-md-4">Tanggal Lahir:</div><div class="col-md-8"><span id="preview_tgl_lahir_pemohon"></span></div></div>
                <div class="row"><div class="col-md-4">Usia Pemohon:</div><div class="col-md-8"><span id="preview_usia_pemohon"></span></div></div>
                <div class="row"><div class="col-md-4">No. KTP (NIK):</div><div class="col-md-8"><span id="preview_no_ktp_pemohon"></span></div></div>
                <div class="row"><div class="col-md-4">Tgl Terbit KTP:</div><div class="col-md-8"><span id="preview_tgl_terbit_ktp"></span></div></div>
                <div class="row"><div class="col-md-4">Status Perkawinan:</div><div class="col-md-8"><span id="preview_status_perkawinan_pemohon"></span></div></div>
                
                <h4 class="mb-3 mt-4">C. Data Pensiun</h4>
                <div class="row"><div class="col-md-4">Jenis Pekerjaan:</div><div class="col-md-8"><span id="preview_jenis_pekerjaan_pemohon"></span></div></div>
                <div class="row"><div class="col-md-4">Instansi Terakhir:</div><div class="col-md-8"><span id="preview_nama_instansi_pemohon"></span></div></div>
                
                <div class="row"><div class="col-md-4">No. SK Pensiun:</div><div class="col-md-8"><span id="preview_no_sk_pensiun"></span></div></div>
                <div class="row"><div class="col-md-4">Tgl. SK Pensiun:</div><div class="col-md-8"><span id="preview_tgl_sk_pensiun"></span></div></div>
                <div class="row"><div class="col-md-4">TMT Pensiun:</div><div class="col-md-8"><span id="preview_tgl_pensiun_tmt"></span></div></div>
                
                <h4 class="mb-3 mt-4">D. Verifikasi</h4>
                <div class="row"><div class="col-md-4">Payroll di Bank:</div><div class="col-md-8"><span id="preview_payroll_bank"></span></div></div>
                <div class="row"><div class="col-md-4">No. Rekening Payroll:</div><div class="col-md-8"><span id="preview_payroll_no_rek"></span></div></div>
                <p class="fw-bold mb-1 mt-3">Gaji Pensiun Diterima:</p>
                <div class="row"><div class="col-md-4"><span id="preview_pensiun_bulan_nama"></span>:</div><div class="col-md-8"><span id="preview_pensiun_bulan_jumlah"></span></div></div>
                <p class="fw-bold mb-1 mt-3">Call Memo:</p>
                <div class="row"><div class="col-md-4">Tanggal Telepon:</div><div class="col-md-8"><span id="preview_tgl_call_memo"></span></div></div>
                <div class="row"><div class="col-md-4">Nama Kerabat:</div><div class="col-md-8"><span id="preview_nama_kerabat"></span></div></div>
                <div class="row"><div class="col-md-4">Hubungan:</div><div class="col-md-8"><span id="preview_hubungan_kerabat"></span></div></div>
                <div class="row"><div class="col-md-4">No. Telp Kerabat:</div><div class="col-md-8"><span id="preview_no_telp_kerabat"></span></div></div>

                <h4 class="mb-3 mt-4">E. Usulan Kredit</h4>
                <div class="row"><div class="col-md-4">DSR Pemohon (%):</div><div class="col-md-8"><span id="preview_dsr_pemohon"></span></div></div>
                <div class="row"><div class="col-md-4">Program Kredit:</div><div class="col-md-8"><span id="preview_program_kredit"></span></div></div>
                <div class="row"><div class="col-md-4">Usulan Plafon (Rp):</div><div class="col-md-8"><span id="preview_usulan_plafon_kredit"></span></div></div>
                <div class="row"><div class="col-md-4">Usulan J.Waktu (Bulan):</div><div class="col-md-8"><span id="preview_usulan_jangka_waktu_bulan"></span></div></div>
                <div class="row"><div class="col-md-4">Usulan Bunga (%):</div><div class="col-md-8"><span id="preview_usulan_bunga_persen"></span></div></div>
                <div class="row"><div class="col-md-4">Angsuran Diusulkan (Rp):</div><div class="col-md-8"><span id="preview_usulan_angsuran"></span></div></div>
                <div class="row"><div class="col-md-4">Biaya Provisi (%):</div><div class="col-md-8"><span id="preview_biaya_provisi_persen"></span></div></div>
                <div class="row"><div class="col-md-4">Biaya Provisi (Rp):</div><div class="col-md-8"><span id="preview_biaya_provisi_nominal"></span></div></div>
                <div class="row"><div class="col-md-4">Biaya Tata Laksana (%):</div><div class="col-md-8"><span id="preview_biaya_tata_laksana_persen"></span></div></div>
                <div class="row"><div class="col-md-4">Biaya Tata Laksana (Rp):</div><div class="col-md-8"><span id="preview_biaya_tata_laksana_nominal"></span></div></div>
                <div class="row"><div class="col-md-4">Biaya Administrasi (Rp):</div><div class="col-md-8"><span id="preview_biaya_administrasi"></span></div></div>
                <div class="row"><div class="col-md-4">Biaya PSJT (%):</div><div class="col-md-8"><span id="preview_biaya_psjt_persen"></span></div></div>
                
                <h5 class="mb-3 mt-4">Blokir Angsuran</h5>
                <div class="row"><div class="col-md-4">Jumlah Blokir Angsuran (kali):</div><div class="col-md-8"><span id="preview_blokir_angsuran_lunas"></span> (<span id="preview_blokir_angsuran_lunas_terbilang"></span>)</div></div>

                <h5 class="mb-3 mt-4">Syarat Tambahan Kustom</h5>
                <div id="preview-syarat-kustom-penandatanganan" class="slik-facility-hidden">
                    <p class="fw-bold mb-1">Syarat Penandatanganan Tambahan:</p>
                    <ul id="preview-list-penandatanganan">
                        </ul>
                </div>
                <div id="preview-syarat-kustom-pencairan" class="slik-facility-hidden">
                    <p class="fw-bold mb-1 mt-3">Syarat Pencairan Tambahan:</p>
                    <ul id="preview-list-pencairan">
                        </ul>
                </div>
                <div id="preview-syarat-kustom-none" class="slik-facility-hidden">
                    <p class="text-body-secondary">Tidak ada syarat tambahan kustom.</p>
                </div>
                
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal, Cek Ulang</button>
                <button type="button" class="btn btn-primary" id="confirm-save">Ya, Simpan Data</button>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // --- (PERBAIKAN) Helper Functions untuk Rupiah ---
        function unformatRupiah(value) { return value.replace(/[^0-9]/g, ''); }
        function formatRupiah(value) {
            // Hapus semua karakter non-numerik
            let number_string = value.replace(/[^0-9]/g, '');
            // Hapus angka nol di depan (jika ada, cth: 0050000)
            number_string = number_string.replace(/^0+/, '');
            
            if (number_string === "") {
                return ""; // Kembalikan string kosong jika tidak ada input
            }

            // (PERBAIKAN) Menggunakan Regex yang lebih stabil
            return number_string.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
        }
        function setupRupiahInput(inputId) {
            const input = document.getElementById(inputId);
            if (input) {
                input.value = formatRupiah(input.value);
                input.addEventListener('input', function(e) {
                    // Simpan posisi kursor
                    let start = e.target.selectionStart;
                    let end = e.target.selectionEnd;
                    let originalLength = e.target.value.length;

                    // Format nilai
                    e.target.value = formatRupiah(e.target.value);
                    
                    // Kembalikan posisi kursor
                    let newLength = e.target.value.length;
                    let diff = newLength - originalLength;
                    
                    // Cek agar kursor tidak lari saat menghapus
                    if (start === end && diff < 0) {
                        e.target.setSelectionRange(start + diff + 1, end + diff + 1);
                    } else {
                        e.target.setSelectionRange(start + diff, end + diff);
                    }
                });
            }
        }

        // --- 1. REFERENSI ELEMEN ---
        const mainForm = document.getElementById('mainForm');
        const tglLahirInput = document.getElementById('tgl_lahir_pemohon');
        const usiaInput = document.getElementById('usia_pemohon');
        const plafonDimohonInput = document.getElementById('plafon_kredit_dimohon');
        const jangkaWaktuDimohonInput = document.getElementById('jangka_waktu_dimohon_bulan');
        const plafonUsulanInput = document.getElementById('usulan_plafon_kredit');
        const jangkaWaktuUsulanInput = document.getElementById('usulan_jangka_waktu_bulan');
        const bungaUsulanInput = document.getElementById('usulan_bunga_persen'); 
        const angsuranUsulanInput = document.getElementById('usulan_angsuran'); 
        const provisiPersenInput = document.getElementById('biaya_provisi_persen');
        const provisiNominalInput = document.getElementById('biaya_provisi_nominal');
        const tataLaksanaPersenInput = document.getElementById('biaya_tata_laksana_persen');
        const tataLaksanaNominalInput = document.getElementById('biaya_tata_laksana_nominal');
        
        const pensiunBulanJumlahInput = document.getElementById('pensiun_bulan_jumlah');
        const dsrPemohonInput = document.getElementById('dsr_pemohon');
        
        const biayaAdminInput = document.getElementById('biaya_administrasi');
        const bebasBiayaAdminCheckbox = document.getElementById('bebas_biaya_administrasi');

        // (PERUBAHAN) Referensi Domisili
        const toggleDomisili = document.getElementById('toggle-domisili');
        const domisiliFields = document.getElementById('domisili-fields');
        const domisiliInputs = domisiliFields.querySelectorAll('textarea');

        const pairsTerbilang = [
            { input: document.getElementById('blokir_angsuran_lunas'), output: document.getElementById('blokir_angsuran_lunas_terbilang') }
        ];

        const nominalInputIDs = [
            'plafon_kredit_dimohon', 'usulan_plafon_kredit', 'usulan_angsuran',
            'pensiun_bulan_jumlah', // <-- Field Purna
            'biaya_provisi_nominal', 'biaya_tata_laksana_nominal', 'biaya_administrasi', 
            'slik_bank_1_maks', 'slik_bank_1_outs', 'slik_bank_1_angsuran',
            'slik_bank_2_maks', 'slik_bank_2_outs', 'slik_bank_2_angsuran',
            'slik_bank_3_maks', 'slik_bank_3_outs', 'slik_bank_3_angsuran',
            'slik_bank_4_maks', 'slik_bank_4_outs', 'slik_bank_4_angsuran',
            'slik_bank_5_maks', 'slik_bank_5_outs', 'slik_bank_5_angsuran',
            'slik_bank_6_maks', 'slik_bank_6_outs', 'slik_bank_6_angsuran',
            'slik_bank_7_maks', 'slik_bank_7_outs', 'slik_bank_7_angsuran',
            'slik_bank_8_maks', 'slik_bank_8_outs', 'slik_bank_8_angsuran',
            'slik_bank_9_maks', 'slik_bank_9_outs', 'slik_bank_9_angsuran',
            'slik_bank_10_maks', 'slik_bank_10_outs', 'slik_bank_10_angsuran',
            'slik_bank_11_maks', 'slik_bank_11_outs', 'slik_bank_11_angsuran',
            'slik_bank_12_maks', 'slik_bank_12_outs', 'slik_bank_12_angsuran',
            'slik_bank_13_maks', 'slik_bank_13_outs', 'slik_bank_13_angsuran',
            'slik_bank_14_maks', 'slik_bank_14_outs', 'slik_bank_14_angsuran',
            'slik_bank_15_maks', 'slik_bank_15_outs', 'slik_bank_15_angsuran',
        ];

        // Referensi SLIK Dinamis
        const addSlikButton = document.getElementById('add-slik-facility');
        const maxFacilities = 15;
        
        // Referensi Syarat Kustom
        const addSyaratButton = document.getElementById('add-syarat-kustom');
        const maxSyarat = 10;
        
        // Referensi Mitigasi Checkbox
        const toggleMitigasi = document.getElementById('toggle-mitigasi');
        const mitigasiFields = document.getElementById('mitigasi-fields');
        const mitigasiInputs = mitigasiFields.querySelectorAll('input, textarea');
        
        // Referensi Checkbox Nihil
        const toggleNihil = document.getElementById('toggle-fasilitas-nihil');
        const allFacilitiesWrapper = document.getElementById('all-facilities-wrapper');

        // Referensi Modal
        const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
        const confirmSaveButton = document.getElementById('confirm-save');

        // --- 2. FUNGSI KALKULASI ---
        function hitungUsia() {
            if (!tglLahirInput.value) { usiaInput.value = ''; return; }
            try {
                const tglLahir = new Date(tglLahirInput.value);
                const hariIni = new Date();
                let usia = hariIni.getFullYear() - tglLahir.getFullYear();
                const selisihBulan = hariIni.getMonth() - tglLahir.getMonth();
                if (selisihBulan < 0 || (selisihBulan === 0 && hariIni.getDate() < tglLahir.getDate())) {
                    usia--;
                }
                usiaInput.value = usia;
            } catch (e) {
                usiaInput.value = '';
            }
        }
        
        function hitungBiaya() {
            const plafon = parseFloat(unformatRupiah(plafonUsulanInput.value)) || 0;
            const provisiPersen = parseFloat(provisiPersenInput.value) || 0;
            const provisiNominal = Math.round((plafon * provisiPersen) / 100);
            provisiNominalInput.value = formatRupiah(String(provisiNominal));
            const tataLaksanaPersen = parseFloat(tataLaksanaPersenInput.value) || 0;
            const tataLaksanaNominal = Math.round((plafon * tataLaksanaPersen) / 100);
            tataLaksanaNominalInput.value = formatRupiah(String(tataLaksanaNominal));
        }
        function syncPengajuanKeUsulan() {
            if (plafonDimohonInput) { plafonUsulanInput.value = plafonDimohonInput.value; }
            if (jangkaWaktuDimohonInput) { jangkaWaktuUsulanInput.value = jangkaWaktuDimohonInput.value; }
            calculateNewPMT(); 
        }
        const angka = ['', 'satu', 'dua', 'tiga', 'empat', 'lima', 'enam', 'tujuh', 'delapan', 'sembilan', 'sepuluh', 'sebelas'];
        function terbilang(n) {
            n = Math.floor(n);
            if (n < 12) return angka[n];
            if (n < 20) return angka[n - 10] + ' belas';
            if (n < 100) return angka[Math.floor(n / 10)] + ' puluh ' + angka[n % 10];
            if (n < 200) return 'seratus ' + terbilang(n - 100);
            if (n < 1000) return angka[Math.floor(n / 100)] + ' ratus ' + terbilang(n % 100);
            if (n < 2000) return 'seribu ' + terbilang(n - 1000);
            if (n < 1000000) return terbilang(Math.floor(n / 1000)) + ' ribu ' + terbilang(n % 1000);
            if (n < 1000000000) return terbilang(Math.floor(n / 1000000)) + ' juta ' + terbilang(n % 1000000);
            return ''; 
        }
        function updateTerbilang(inputElement, outputElement) {
            const nilai = parseFloat(inputElement.value) || 0;
            if (nilai === 0) {
                outputElement.value = ''; return;
            }
            let hasil = terbilang(nilai).trim().replace(/\s+/g, ' '); 
            hasil = hasil.charAt(0).toUpperCase() + hasil.slice(1);
            outputElement.value = hasil;
        }

        function calculateNewPMT() {
            const P = parseFloat(unformatRupiah(plafonUsulanInput.value)) || 0;
            const annualRate = parseFloat(bungaUsulanInput.value) || 0;
            const N = parseInt(jangkaWaktuUsulanInput.value) || 0;

            if (P === 0 || N === 0) {
                angsuranUsulanInput.value = '';
                calculateDSR(); 
                return;
            }
            if (annualRate === 0) {
                const pmt = Math.ceil(P / N);
                angsuranUsulanInput.value = formatRupiah(String(pmt));
                calculateDSR(); 
                return;
            }
            const R = (annualRate / 100) / 12;
            const pmt = (P * (R * Math.pow(1 + R, N))) / (Math.pow(1 + R, N) - 1);
            const pmtRounded = Math.ceil(pmt);
            angsuranUsulanInput.value = formatRupiah(String(pmtRounded));
            calculateDSR(); 
        }

        // Kalkulasi DSR untuk Purna
        function calculateDSR() {
            const penghasilan = parseFloat(unformatRupiah(pensiunBulanJumlahInput.value)) || 0;
            const angsuranUsulan = parseFloat(unformatRupiah(angsuranUsulanInput.value)) || 0;

            let totalAngsuranEksisting = 0;
            if (!toggleNihil.checked) {
                for (let i = 1; i <= maxFacilities; i++) {
                    const angsuranInput = document.getElementById('slik_bank_' + i + '_angsuran');
                    if (angsuranInput) {
                        totalAngsuranEksisting += parseFloat(unformatRupiah(angsuranInput.value)) || 0;
                    }
                }
            }

            const totalAngsuranBaru = angsuranUsulan + totalAngsuranEksisting;
            let dsr = 0;
            if (penghasilan > 0) {
                dsr = (totalAngsuranBaru / penghasilan) * 100;
            }
            
            dsrPemohonInput.value = dsr.toFixed(2);
        }

        // --- (Fungsi Toggle) ---
        function handleNihilToggle() {
            if (toggleNihil.checked) {
                allFacilitiesWrapper.style.display = 'none';
                allFacilitiesWrapper.querySelectorAll('input, textarea').forEach(input => input.disabled = true);
                addSlikButton.disabled = true;
            } else {
                allFacilitiesWrapper.style.display = 'block';
                allFacilitiesWrapper.querySelectorAll('input').forEach(input => {
                    input.disabled = false;
                });
                addSlikButton.disabled = false;
                initAlasanCheckboxes(); 
            }
            calculateDSR(); 
        }
        function handleMitigasiToggle() {
            if (toggleMitigasi.checked) {
                mitigasiFields.style.display = 'block';
                mitigasiInputs.forEach(input => input.disabled = false);
            } else {
                mitigasiFields.style.display = 'none';
                mitigasiInputs.forEach(input => input.disabled = true);
            }
        }
        function handleAlasanToggle(checkbox) {
            const targetAlasan = document.querySelector(checkbox.dataset.targetAlasan);
            if (!targetAlasan) return;
            const wrapper = targetAlasan.closest('.alasan-wrapper');
            if (checkbox.checked) {
                wrapper.style.display = 'block';
                targetAlasan.disabled = false;
            } else {
                wrapper.style.display = 'none';
                targetAlasan.disabled = true;
                targetAlasan.value = '';
            }
        }
        function initAlasanCheckboxes() {
            document.querySelectorAll('.toggle-alasan').forEach(handleAlasanToggle);
        }
        
        function handleBebasAdminToggle() {
            if (bebasBiayaAdminCheckbox && bebasBiayaAdminCheckbox.checked) {
                biayaAdminInput.disabled = true;
                biayaAdminInput.value = '';
            } else if (biayaAdminInput) {
                biayaAdminInput.disabled = false;
            }
        }
        
        // (PERUBAHAN) Fungsi toggle untuk Domisili
        function handleDomisiliToggle() {
            if (toggleDomisili.checked) {
                domisiliFields.style.display = 'block';
                domisiliInputs.forEach(input => input.disabled = false);
            } else {
                domisiliFields.style.display = 'none';
                domisiliInputs.forEach(input => {
                    input.disabled = true;
                    input.value = ''; // Kosongkan saat disembunyikan
                });
            }
        }

        // --- FUNGSI PREVIEW ---
        function populatePreview() {
            for (const input of mainForm.elements) {
                const inputId = input.id;
                if (!inputId) continue; 
                const previewElement = document.getElementById('preview_' + inputId);
                if (previewElement) {
                    if (input.tagName === 'TEXTAREA') {
                        previewElement.textContent = input.value;
                    } else if (input.type === 'checkbox') {
                        if (input.id.includes('_takeover') && input.checked) {
                            previewElement.textContent = ' (Take Over)';
                        } else if (input.id.includes('_takeover') && !input.checked) {
                            previewElement.textContent = '';
                        }
                        
                        if (input.id === 'bebas_biaya_administrasi' && input.checked) {
                            previewElement.textContent = 'Bebas Biaya Administrasi';
                        } else if (input.id === 'bebas_biaya_administrasi' && !input.checked) {
                            previewElement.textContent = document.getElementById('biaya_administrasi').value;
                        }

                    } else {
                        previewElement.textContent = input.value;
                    }
                }
            }
            const previewMitigasiSection = document.getElementById('preview-mitigasi-section');
            if (toggleMitigasi.checked) {
                previewMitigasiSection.style.display = 'block';
            } else {
                previewMitigasiSection.style.display = 'none';
            }
            const previewNihil = document.getElementById('preview-fasilitas-nihil');
            const previewFacilities = document.getElementById('preview-facilities-wrapper');
            if (toggleNihil.checked) {
                previewFacilities.style.display = 'none';
                previewNihil.style.display = 'block';
            } else {
                previewFacilities.style.display = 'block';
                previewNihil.style.display = 'none';
                
                for (let i = 1; i <= maxFacilities; i++) {
                    const facilityDiv = document.getElementById('slik-facility-' + i);
                    const previewFacilityDiv = document.getElementById('preview-slik-facility-' + i);
                    const alasanCheckbox = document.getElementById('slik_bank_' + i + '_alasan_aktif');
                    const previewAlasanWrapper = document.getElementById('preview-alasan-wrapper-' + i);
                    
                    const isVisible = (i === 1) || (facilityDiv && window.getComputedStyle(facilityDiv).display === 'block');
                    const previewBlock = (i === 1) ? document.getElementById('preview-facilities-wrapper').querySelector('.row') : previewFacilityDiv;
                    
                    if (isVisible && previewBlock) {
                        if (i > 1) previewBlock.style.display = 'block';
                        
                        if (alasanCheckbox && alasanCheckbox.checked) {
                            if (previewAlasanWrapper) previewAlasanWrapper.style.display = 'block';
                        } else {
                            if (previewAlasanWrapper) previewAlasanWrapper.style.display = 'none';
                        }
                    } else if (previewFacilityDiv) {
                        previewFacilityDiv.style.display = 'none';
                    }
                }
            }

            // (PERUBAHAN) Logika Preview Domisili
            const previewDomisiliWrapper = document.getElementById('preview-domisili-wrapper');
            if (toggleDomisili.checked && document.getElementById('alamat_domisili_pemohon').value) {
                // 'flex' digunakan oleh Bootstrap .row
                previewDomisiliWrapper.style.display = 'flex'; 
            } else {
                previewDomisiliWrapper.style.display = 'none';
            }
            
            const listPenandatanganan = document.getElementById('preview-list-penandatanganan');
            const listPencairan = document.getElementById('preview-list-pencairan');
            const noSyaratDiv = document.getElementById('preview-syarat-kustom-none');
            
            listPenandatanganan.innerHTML = '';
            listPencairan.innerHTML = '';
            let hasSyaratPenandatanganan = false;
            let hasSyaratPencairan = false;

            for (let i = 1; i <= maxSyarat; i++) {
                const teksEl = document.getElementById(`syarat_kustom_${i}_teks`);
                if (teksEl && teksEl.value) { 
                    const teks = teksEl.value;
                    const lokasi = document.querySelector(`input[name="syarat_kustom_${i}_lokasi"]:checked`);
                    if (lokasi && lokasi.value === 'penandatanganan') {
                        const li = document.createElement('li');
                        li.textContent = teks;
                        listPenandatanganan.appendChild(li);
                        hasSyaratPenandatanganan = true;
                    } else if (lokasi && lokasi.value === 'pencairan') {
                        const li = document.createElement('li');
                        li.textContent = teks;
                        listPencairan.appendChild(li);
                        hasSyaratPencairan = true;
                    }
                }
            }
            
            document.getElementById('preview-syarat-kustom-penandatanganan').style.display = hasSyaratPenandatanganan ? 'block' : 'none';
            document.getElementById('preview-syarat-kustom-pencairan').style.display = hasSyaratPencairan ? 'block' : 'none';
            noSyaratDiv.style.display = (!hasSyaratPenandatanganan && !hasSyaratPencairan) ? 'block' : 'none';
        }

        // --- 3. EVENT LISTENERS ---
        if (tglLahirInput) tglLahirInput.addEventListener('change', hitungUsia);
        if (provisiPersenInput) provisiPersenInput.addEventListener('input', hitungBiaya);
        if (tataLaksanaPersenInput) tataLaksanaPersenInput.addEventListener('input', hitungBiaya);
        if (plafonDimohonInput) plafonDimohonInput.addEventListener('input', syncPengajuanKeUsulan);
        if (jangkaWaktuDimohonInput) jangkaWaktuDimohonInput.addEventListener('input', syncPengajuanKeUsulan);
        if (bungaUsulanInput) bungaUsulanInput.addEventListener('input', calculateNewPMT);
        
        if (bebasBiayaAdminCheckbox) {
            bebasBiayaAdminCheckbox.addEventListener('change', handleBebasAdminToggle);
        }

        // (PERUBAHAN) Listener untuk Domisili
        if (toggleDomisili) {
            toggleDomisili.addEventListener('change', handleDomisiliToggle);
        }

        if (pensiunBulanJumlahInput) pensiunBulanJumlahInput.addEventListener('input', calculateDSR);
        
        for (let i = 1; i <= maxFacilities; i++) {
            const angsuranInput = document.getElementById('slik_bank_' + i + '_angsuran');
            if (angsuranInput) {
                angsuranInput.addEventListener('input', calculateDSR);
            }
        }
        
        pairsTerbilang.forEach(pair => {
            if (pair.input) {
                pair.input.addEventListener('input', function() {
                    updateTerbilang(pair.input, pair.output);
                });
            }
        });
        
        if (addSlikButton) {
            addSlikButton.addEventListener('click', function() {
                let found = false;
                for (let i = 2; i <= maxFacilities; i++) {
                    const nextFacility = document.getElementById('slik-facility-' + i);
                    if (nextFacility && window.getComputedStyle(nextFacility).display === 'none') {
                        nextFacility.style.display = 'block';
                        found = true;
                        break; 
                    }
                }
                let hasMore = false;
                for (let i = 2; i <= maxFacilities; i++) {
                    const facility = document.getElementById('slik-facility-' + i);
                    if (facility && window.getComputedStyle(facility).display === 'none') {
                        hasMore = true;
                        break;
                    }
                }
                if (!hasMore) {
                    addSlikButton.style.display = 'none';
                }
            });
        }
        
        if (addSyaratButton) {
            addSyaratButton.addEventListener('click', function() {
                let found = false;
                for (let i = 1; i <= maxSyarat; i++) {
                    const nextSyarat = document.getElementById('syarat-kustom-' + i);
                    if (nextSyarat && window.getComputedStyle(nextSyarat).display === 'none') {
                        nextSyarat.style.display = 'block';
                        found = true;
                        break; 
                    }
                }
                let hasMore = false;
                for (let i = 1; i <= maxSyarat; i++) {
                    const syarat = document.getElementById('syarat-kustom-' + i);
                    if (syarat && window.getComputedStyle(syarat).display === 'none') {
                        hasMore = true;
                        break;
                    }
                }
                if (!hasMore) {
                    addSyaratButton.style.display = 'none';
                }
            });
        }
        
        document.getElementById('syarat-kustom-container').addEventListener('click', function(e) {
            if (e.target.classList.contains('syarat-delete-btn')) {
                const syaratId = e.target.getAttribute('data-syarat-id');
                const syaratBlock = document.getElementById('syarat-kustom-' + syaratId);
                if (syaratBlock) {
                    syaratBlock.style.display = 'none';
                    syaratBlock.querySelectorAll('input, textarea').forEach(input => {
                        if (input.type === 'radio' || input.type === 'checkbox') {
                            input.checked = false;
                        } else {
                            input.value = '';
                        }
                    });
                    addSyaratButton.style.display = 'block';
                }
            }
        });

        document.getElementById('all-facilities-wrapper').addEventListener('click', function(e) {
            if (e.target.classList.contains('slik-delete-btn')) {
                const facilityId = e.target.getAttribute('data-facility-id');
                const facilityBlock = document.getElementById('slik-facility-' + facilityId);
                if (facilityBlock) {
                    facilityBlock.style.display = 'none';
                    facilityBlock.querySelectorAll('input, textarea').forEach(input => {
                        if (input.type === 'checkbox') {
                            input.checked = false;
                        } else {
                            input.value = '';
                        }
                    });
                    const alasanCheckbox = facilityBlock.querySelector('.toggle-alasan');
                    if (alasanCheckbox) {
                        handleAlasanToggle(alasanCheckbox);
                    }
                    addSlikButton.style.display = 'block';
                    calculateDSR(); 
                }
            }
        });

        if (toggleNihil) {
            toggleNihil.addEventListener('change', handleNihilToggle);
        }
        if (toggleMitigasi) {
            toggleMitigasi.addEventListener('change', handleMitigasiToggle);
        }
        mainForm.addEventListener('change', function(e) {
            if (e.target.classList.contains('toggle-alasan')) {
                handleAlasanToggle(e.target);
            }
        });
        if (mainForm) {
            mainForm.addEventListener('submit', function(e) {
                e.preventDefault();
                if (!mainForm.checkValidity()) {
                    mainForm.reportValidity();
                    return;
                }
                populatePreview();
                previewModal.show();
            });
        }
        if (confirmSaveButton) {
            confirmSaveButton.addEventListener('click', function() {
                previewModal.hide();
                mainForm.submit();
            });
        }

        // --- 4. KALKULASI & FORMAT SAAT HALAMAN DIMUAT ---
        
        setTimeout(function() {
            
            nominalInputIDs.forEach(setupRupiahInput);
            hitungUsia();
            syncPengajuanKeUsulan(); 
            calculateDSR(); 
            
            pairsTerbilang.forEach(pair => {
                if (pair.input && pair.input.value) {
                    updateTerbilang(pair.input, pair.output);
                }
            });
            
            const isNihilString = "{{ data.get('fasilitas_nihil', 'no') }}";
            const isMitigasiString = "{{ data.get('mitigasi_aktif', 'no') }}";
            const isBebasAdminString = "{{ data.get('bebas_biaya_administrasi', 'no') }}"; 
            // (PERUBAHAN)
            const isDomisiliBerbedaString = "{{ data.get('domisili_berbeda', 'no') }}";
            
            const isNihil = (isNihilString === 'ya');
            const isMitigasi = (isMitigasiString === 'ya');
            const isBebasAdmin = (isBebasAdminString === 'ya'); 
            // (PERUBAHAN)
            const isDomisiliBerbeda = (isDomisiliBerbedaString === 'ya');

            toggleNihil.checked = isNihil;
            toggleMitigasi.checked = isMitigasi;
            if (bebasBiayaAdminCheckbox) bebasBiayaAdminCheckbox.checked = isBebasAdmin; 
            if (toggleDomisili) toggleDomisili.checked = isDomisiliBerbeda;
            
            handleNihilToggle();
            handleMitigasiToggle();
            initAlasanCheckboxes();
            if (bebasBiayaAdminCheckbox) handleBebasAdminToggle(); 
            if (toggleDomisili) handleDomisiliToggle();
            
            let allSlikVisible = true;
            for (let i = 2; i <= maxFacilities; i++) {
                const facility = document.getElementById('slik-facility-' + i); 
                if (!facility || window.getComputedStyle(facility).display === 'none') {
                    allSlikVisible = false;
                    break;
                }
            }
            if (allSlikVisible) addSlikButton.style.display = 'none';

            let allSyaratVisible = true;
            for (let i = 1; i <= maxSyarat; i++) {
                const syarat = document.getElementById('syarat-kustom-' + i); 
                if (!syarat || window.getComputedStyle(syarat).display === 'none') {
                    allSyaratVisible = false;
                    break;
                }
            }
            if (allSyaratVisible) addSyaratButton.style.display = 'none';
            
        }, 10); 
        
        // --- EVENT LISTENER GANTI TEMA ---
        (function() {
            const themeToggler = document.getElementById('theme-toggler');
            if (!themeToggler) return;
    
            function applyTheme(theme) {
                if (theme === 'dark') {
                    document.documentElement.setAttribute('data-bs-theme', 'dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.documentElement.setAttribute('data-bs-theme', 'light');
                    localStorage.setItem('theme', 'light');
                }
            }
    
            themeToggler.addEventListener('click', () => {
                const currentTheme = document.documentElement.getAttribute('data-bs-theme') || 'light';
                applyTheme(currentTheme === 'dark' ? 'light' : 'dark');
            });
        })();

    });
</script>

</body>
</html>